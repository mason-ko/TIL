# 다루는 내용
- 다중 컨테이너 파드 생성
- 컨테이너 간 디스크 스토리지를 공유하기 위한 볼륨 생성
- 파드 내부에 깃 리포지터리 사용
- 파드에 GCE 퍼시스턴트 디스크와 같은 퍼시스턴트 스토리지 연결
- 사전 프로비저닝된 퍼시스턴트 스토리지
- 퍼시스턴트 스토리지의 동적 프로비저닝

# index
- [6.볼륨: 컨테이너에 디스크 스토리지 연결](#6볼륨-컨테이너에-디스크-스토리지-연결)
  - [6.1 볼륨 소개](#61-볼륨-소개)
  - [6.2 볼륨을 사용한 컨테이너 간 데이터 공유](#62-볼륨을-사용한-컨테이너-간-데이터-공유)
  - [6.3 워커 노드 파일시스템의 파일 접근](#63-워커-노드-파일시스템의-파일-접근)
  - [6.4 퍼시스턴트 스토리지 사용](#64-퍼시스턴트-스토리지-사용)
  - [6.5 기반 스토리지 기술과 파드 분리](#65-기반-스토리지-기술과-파드-분리)
  - [6.6 퍼시스턴트볼륨의 동적 프로비저닝](#66-퍼시스턴트볼륨의-동적-프로비저닝)
  - [6.7 요약](#67-요약)

### 들어가기전에
쿠버네티스에서 볼륨은 주로 데이터를 저장하고 공유하는 데 사용되는 기능입니다. 파드와 컨테이너의 라이프사이클과 독립적으로 지속되며, 여러 컨테이너 간에 데이터를 공유할 수 있게 해줍니다. 볼륨 마운트에 대해 이해하기 위해 먼저 알아두면 좋은 개념들이 있습니다.
* 파드의 라이프사이클과 볼륨의 라이프사이클: 파드의 모든 컨테이너는 동일한 라이프사이클을 공유하지만, 볼륨은 파드의 라이프사이클과는 독립적입니다. 즉, 파드가 삭제되더라도 볼륨의 데이터는 지속될 수 있습니다.
* Persistent Volumes (PV) 및 Persistent Volume Claims (PVC): Persistent Volumes(PV)는 클러스터의 저장소를 나타내는 API 리소스이며, Persistent Volume Claims(PVC)는 사용자에 의해 생성되어 PV를 요청하는 API 리소스입니다. PVC가 만들어지면, 쿠버네티스 스케줄러는 PVC의 요구사항을 만족하는 PV를 찾아 바인딩합니다.
* 볼륨 타입: 쿠버네티스는 다양한 유형의 볼륨을 지원합니다. 이들은 각각의 특징과 제한사항이 있으므로, 각 볼륨 타입의 특성과 사용 사례를 이해하는 것이 중요합니다. 일부 볼륨 타입에는 emptyDir, hostPath, nfs, persistentVolumeClaim, secret 등이 있습니다.
* Access Modes: 볼륨은 ReadWriteOnce (한 노드에서 읽기/쓰기), ReadOnlyMany (여러 노드에서 읽기 전용), ReadWriteMany (여러 노드에서 읽기/쓰기) 등 다양한 접근 모드를 가질 수 있습니다. 이러한 모드는 사용하는 저장소 타입과 애플리케이션의 요구사항에 따라 결정됩니다.
* Storage Class: 스토리지 클래스는 동적 볼륨 프로비저닝을 위한 방법을 제공합니다. 이는 관리자가 다양한 종류의 스토리지 (예: AWS EBS, Azure Disk, GCE Persistent Disk, Glusterfs 등) 및 그들의 세부 구성을 사전에 정의할 수 있게 해줍니다.
* 볼륨 마운트: 파드 내의 컨테이너는 볼륨을 특정 경로에 마운트하여 사용할 수 있습니다. 이는 볼륨의 데이터를 컨테이너에서 사용 가능하게 하며, 여러 컨테이너 간에 데이터를 공유할 수 있게 해줍니다.


# [6.볼륨: 컨테이너에 디스크 스토리지 연결](#index)
- 파드 내부의 각 컨테이너는 고유하게 분리된 파일 시스템을 가진다.
- 재시작 시 기존 데이터는 삭제됨.
- 새로운 컨테이너가 이전의 위치에서 계속되기를 원하거나, 실제 데이터의 디렉터리를 보존하고 싶을 때 볼륨을 사용.

> 볼륨을 사용하는 대표적인 케이스 
- **컨테이너 내 데이터 영속화**: Pod 삭제 및 재시작 시 컨테이너 내 데이터 유실 방지를 위해 (db, message queue, 등 statusful 애플리케이션 운영 가능)
- **여러 컨테이너 간 데이터 공유**: 여러 컨테이너 간 데이터를 공유해서 쉐어 시
- **시크릿 및 설정파일 공유**: secret, configmap 객체는 볼륨으로 마운트해서 애플리케이션 설정 등을 공유
- **로그 저장**: 애플리케이션 로그를 외부 시스템에 저장 및 수집
- **저장소 확장 및 이동**: 클러스터 내 스토리지 이동 또는 스토리지를 클러스터 외부 확장에 사용하여, 고가용성 및 재해복구 

## [6.1 볼륨 소개](#index)
독립적인 쿠버네티스 오브젝트가 아니므로 자체 생성 삭제 불가
기본적으로 각 컨테이너는 잘 정의된 단일 책임을 가지고 있지만 각각 컨테이너 자체만으로는 큰 쓸모가 없다.
공유 스토리지가 없으면 각 파드에서 공통적인 데이터를 제공할 수 없음, 그렇기 때문에 볼륨을 사용해야함.

### 사용 가능한 볼륨 유형
- **emptyDir**: 일시적인 데이터를 저장하는데 사용하는 빈 디렉터리
- **hostPath**: 워커 노드의 파일시스템을 파드의 디렉터리로 마운트하는데 사용
  - 노드의 서비스와 함께 동작하는 파드에 대한 데이터를 저장하거나 사용하는경우
  - 쿠버네티스 애플리케이션을 개발할때
  - 노드의 장치파일을 파드에서 사용해야하는 경우
  - 주의사항: 노드의 파일시스템을 사용하기 때문에 파드가 다른 노드로 이동하면 원래 노드의 파일&디렉터리에 접근할 수 없다.
    그렇기 때문에 특정노드에 파드가 고정되어야하는 특수한 경우나, 모든 노드에 공통적으로 존재하는 파일이나 디렉터리에 접근해야하는 경우에 주로사용된다.
- **gitRepo**: 깃 레포의 콘텐츠를 체크아웃해 초기화한 볼륨 ( 유지보수중단됨 - https://kubernetes.io/docs/concepts/storage/volumes/#gitrepo )
- **nfs**: NFS 공유를 파드에 마운트
- **gcePersistentDisk,awsElasticBlockStore,azureDisk**: 클라우드 제공자의 전용 스토리지 마운트
- **cinder, cephfs, iscsi, flocker, glusterfs, quobyte, rbd, flexVolume, vsphere Volume, photonPersistentDisk，scalelO**: 다른 유형의 네트워크 스토리지 마운트
- **configMap, secret, downwardAPI**: 쿠버네티스 리소스나 클러스터 정보를 파드에 노출하는데 사용되는 특별한 유형의 볼륨
- **persistentVolumeClaim**: 사전에 혹은 동적으로 프로비저닝된 퍼시스턴트 스토리지를 사용 

## [6.2 볼륨을 사용한 컨테이너 간 데이터 공유](#index)
### emptyDir 볼륨 사용
시작 시 빈 디렉터리로 시작
파드가 삭제되면 볼륨의 콘텐츠도 삭제
**동일파드에서 실행중인 컨테이너 간 파일 공유할때 유용**
단일 컨테이너에서도 임시 데이터를 디스크에 쓰는 목적에서 사용
컨테이너의 파일시스템은 쓰기가 불가할수도있고 마운트된 볼륨에 쓰는것이 유일한 옵션일 수 있음
### 파드 생성하기 
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: fortune
spec:
  containers:
  - image: luksa/fortune
    name: html-generator
    volumeMounts: # html이란 이름의 볼륨을 컨테이너의 /var/htdocs에 마운트 
    - name: html
      mountPath: /var/htdocs
  - image: nginx:alpine
    name: web-server
    volumeMounts: # 동일 볼륨을 /usr/share/nginx/html 에 마운트 
    - name: html
      mountPath: /usr/share/nginx/html
      readOnly: true
    ports:
    - containerPort: 80
      protocol: TCP
  volumes: # html이란 단일 emptyDir 볼륨을 위 컨테이너 두개에 마운트
  - name: html
    emptyDir: {}
```
### gitRepo
유지보수 중단으로 패스
## [6.3 워커 노드 파일시스템의 파일 접근](#index)
대부분의 파드는 호스트 노드를 인식하지 못하므로 노드의 파일시스템에 있는 어떤파일에도 접근하면 안됨
그러나 특정 시스템 레벨의 파드는 노드의 파일을 읽거나 할 때 사용
### hostPath 볼륨 소개
여러 파드가 동일 경로를 사용중이면 동일 파일 표시
파드가 종료되도 콘텐츠는 삭제되지 않음 ( 데이터 유지 )

## [6.4 퍼시스턴트 스토리지 사용](#index)
## [6.5 기반 스토리지 기술과 파드 분리](#index)
## [6.6 퍼시스턴트볼륨의 동적 프로비저닝](#index)
## [6.7 요약](#index)
