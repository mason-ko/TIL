# 디플로이먼트: 선언적 애플리케이션 업데이트

## 목차

- [9.1 파드에서 실행 중인 애플리케이션 업데이트](#91-파드에서-실행-중인-애플리케이션-업데이트)
  - [9.1.1 오래된 파드를 삭제하고 새 파드로 교체](#911-오래된-파드를-삭제하고-새-파드로-교체)
  - [9.1.2 새 파드 기동과 이전 파드 삭제](#912-새-파드-기동과-이전-파드-삭제)
- [9.2 레플리케이션컨트롤러로 자동 롤링 업데이트 수행](#92-레플리케이션컨트롤러로-자동-롤링-업데이트-수행)
  - [9.2.1 애플리케이션의 초기 버전 실행](#921-애플리케이션의-초기-버전-실행)
  - [9.2.2 kubectl을 이용한 롤링 업데이트](#922-kubectl을-이용한-롤링-업데이트)
  - [9.2.3 kubectl rolling-updateS 더 이상 사용하지 않는 이유](#923-kubectl-rolling-updates-더-이상-사용하지-않는-이유)
- [9.3 애플리케이션을 선언적으로 업데이트하기 위한 디플로이먼트 사용하기](#93-애플리케이션을-선언적으로-업데이트하기-위한-디플로이먼트-사용하기)
  - [9.3.1 디플로이먼트 생성](#931-디플로이먼트-생성)
  - [9.3.2 디플로이먼트 업데이트](#932-디플로이먼트-업데이트)
  - [9.3.3 디플로이먼트롤백](#933-디플로이먼트롤백)
  - [9.3.4 롤아웃 속도 제어](#934-롤아웃-속도-제어)
  - [9.3.5 롤아웃 프로세스 일시 중지](#935-롤아웃-프로세스-일시-중지)
  - [9.3.6 잘못된 버전의 롤아웃 방지](#936-잘못된-버전의-롤아웃-방지)
- [9.4 요약](#94-요약)

## 9.1 파드에서 실행 중인 애플리케이션 업데이트
<img width="435" alt="image" src="https://github.com/mason-ko/TIL/assets/30224146/e56820e5-a94a-4092-a500-6c61d9dec9aa">

파드를 업데이트 하는 방법
- 기존 파드를 모두 삭제한 다음 새 파드를 시작
  - 장점: 한가지 버전으로 가능 
  - 단점: 중단 시간 있음 
- 새로운 파드를 시작하고, 기동하면 기존 파드를 삭제, 점진적으로 제거
  - 장점: 무중단 
  - 단점: 두가지 버전 호환 

### 9.1.1 오래된 파드를 삭제하고 새 파드로 교체
<img width="772" alt="image" src="https://github.com/mason-ko/TIL/assets/30224146/e672172b-764a-41e9-a6a4-2aa5e5196a08">
간단하지만 다운타임이 있다.

### 9.1.2 새 파드 기동과 이전 파드 삭제
다운타임이 발생하지 않고 변경 시 두배의 파드가 실행되므로 더 많은 하드웨어 리소스가 필요.  

#### 한번에 이전 버전에서 새 버전으로 전환
블루-그린 배포 전략(Blue-Green Deployment)은 새로운 버전의 애플리케이션을 안전하게 배포하는 전략 중 하나입니다. 기본 아이디어는 동시에 두 개의 동일한 프로덕션 환경(블루와 그린)을 유지하면서 한 환경에는 현재 버전(예: 블루)을, 다른 환경에는 새 버전(예: 그린)을 배포하는 것입니다. 배포가 완료되면 트래픽을 새로운 버전으로 전환하여 서비스 중단 시간 없이 신규 버전을 활성화합니다.  
<img width="772" alt="image" src="https://github.com/mason-ko/TIL/assets/30224146/9be2b621-4f05-4a84-8382-ebca932d6e79">

#### 롤링 업데이트 수행 
롤링 업데이트(Rolling Update)는 쿠버네티스(Kubernetes)에서 애플리케이션의 새로운 버전을 점진적으로 배포하는 전략입니다. 롤링 업데이트는 서비스 중단 없이 애플리케이션을 업데이트하는 데 유용하며, 모든 인스턴스를 동시에 업데이트하는 대신 일부 인스턴스를 새 버전으로 점진적으로 교체합니다.  
- 롤링 업데이트의 장점:
  - 중단 시간 없음: 롤링 업데이트는 애플리케이션의 가용성을 유지하면서 새 버전을 점진적으로 배포합니다.
  - 자원 효율성: 블루-그린 배포와 달리 롤링 업데이트는 추가적인 인프라나 환경을 요구하지 않습니다.
  - 자동 롤백: 설정에 따라 쿠버네티스는 업데이트 중 문제가 발생하면 자동으로 롤백할 수 있습니다.
- 롤링 업데이트의 단점:
  - 교차 버전 문제: 롤링 업데이트 도중에 두 버전의 애플리케이션이 동시에 실행될 수 있습니다. 이로 인해 호환성 문제가 발생할 수 있습니다.
  - 느린 배포: 큰 클러스터에서는 롤링 업데이트가 시간이 오래 걸릴 수 있습니다.

## 9.2 레플리케이션컨트롤러로 자동 롤링 업데이트 수행
### 9.2.1 애플리케이션의 초기 버전 실행
```yaml
apiVersion: v1
kind: ReplicationController
metadata:
  name: kubia-v1
spec:
  replicas: 3
  template:
    metadata:
      name: kubia
      labels:
        app: kubia
    spec:
      containers: 
      - image: luksa/kubia:v1 # 이 이미지를 실행하는 파드에 대한 레플리케이션컨트롤러를 
        name: nodejs   # 만들고 있다.
--- # yaml 파일에는 대시 3개가 있는 줄로 구분해 여러 리소스 정의를 포함할 수 있다. 
apiVersion: v1
kind: Service
metadata:
  name: kubia
spec:
  type: LoadBalancer
  selector:
    app: kubia
  ports:
  - port: 80
    targetPort: 8080
```

### 9.2.2 kubectl을 이용한 롤링 업데이트
이미지 변경 배포 이후 
```
$ kubectl rolling-update kubia-v1 kubia-v2 --image=luksa/kubia:v2

$ kubectl describe rc kubia-v2 
```

<img width="748" alt="image" src="https://github.com/mason-ko/TIL/assets/30224146/4e5d96e0-f535-445f-ab86-26037d8fb22c">


### 9.2.3 kubectl rolling-updateS 더 이상 사용하지 않는 이유



## 9.3 애플리케이션을 선언적으로 업데이트하기 위한 디플로이먼트 사용하기
### 9.3.1 디플로이먼트 생성


### 9.3.2 디플로이먼트 업데이트


### 9.3.3 디플로이먼트롤백

### 9.3.4 롤아웃 속도 제어


### 9.3.5 롤아웃 프로세스 일시 중지


### 9.3.6 잘못된 버전의 롤아웃 방지


## 9.4 요약

