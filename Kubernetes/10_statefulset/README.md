# 10장 스테이트풀셋: 복제된 스테이트풀 애플리케이션 배포하기

## 목차
- [10.1 스테이트풀 파드 복제하기](#101-스테이트풀-파드-복제하기)
    - [10.1.1 개별 스토리지를 갖는 레플리카 여러 개 실행하기](#1011-개별-스토리지를-갖는-레플리카-여러-개-실행하기)
    - [10.1.2 각 파드에 안정적인 아이덴티티 제공하기](#1012-각-파드에-안정적인-아이덴티티-제공하기)
- [10.2 스테이트풀셋 이해하기](#102-스테이트풀셋-이해하기)
    - [10.2.1 스테이트풀셋과 레플리카셋 비교하기](#1021-스테이트풀셋과-레플리카셋-비교하기)
    - [10.2.2 안정적인 네트워크 아이덴티티 제공하기](#1022-안정적인-네트워크-아이덴티티-제공하기)
    - [10.2.3 각 스테이트풀 인스턴스에 안정적인 전용 스토리지 제공하기](#1023-각-스테이트풀-인스턴스에-안정적인-전용-스토리지-제공하기)
    - [10.2.4 스테이트풀셋 보장 이해하기](#1024-스테이트풀셋-보장-이해하기)
- [10.3 스테이트풀셋 사용하기](#103-스테이트풀셋-사용하기)
    - [10.3.1 애플리케이션과 컨테이너 이미지 생성하기](#1031-애플리케이션과-컨테이너-이미지-생성하기)
    - [10.3.2 스테이트풀셋을 통한 애플리케이션 배포하기](#1032-스테이트풀셋을-통한-애플리케이션-배포하기)
    - [10.3.3 파드가지고 놀기](#1033-파드가지고-놀기)
- [10.4 스테이트풀셋의 피어 디스커버리](#104-스테이트풀셋의-피어-디스커버리)
    - [10.4.1 DNS를 통한 피어 디스커버리](#1041-DNS를-통한-피어-디스커버리)
    - [10.4.2 스테이트풀셋 업데이트](#1042-스테이트풀셋-업데이트)
    - [10.4.3 클러스터된 데이터 저장소 사용하기](#1043-클러스터된-데이터-저장소-사용하기)
- [10.5 스테이트풀셋이 노드 실패를 처리하는 과정 이해하기](#105-스테이트풀셋이-노드-실패를-처리하는-과정-이해하기)
    - [10.5.1 노드의 네트워크 연결 해제 시물레이션](#1051-노드의-네트워크-연결-해제-시물레이션)
    - [10.5.2 수동으로 파드 삭제하기](#1052-수동으로-파드-삭제하기)

스테이트풀셋은 쿠버네티스에서 스테이트풀 애플리케이션을 관리하기 위한 API 오브젝트 중 하나입니다.  
스테이트풀 애플리케이션은 데이터를 지속적으로 저장하고 관리해야하는 애플리케이션을 말하며, DB, 캐시, MQ 등이 해당.  
스테이트풀셋은 파드에 순서와 고유한 아이덴티티를 부여합니다. 이는 스테이트리스 애플리케이션을 관리하기 위한 레플리카셋(ReplicaSet)과는 다른 점입니다.  
레플리카셋은 파드간에 구별되는 고유성이 필요 없고, 상태를 유지할 필요가 없습니다.

#### 스테이트풀셋 사용해야 하는 이유
- 데이터 지속성: 스테이트풀 애플리케이션은 데이터를 지속적으로 저장하고, 애플리케이션 상태를 유지해야 하는 경우가 많습니다. 스테이트풀셋은 각 파드에 고유한 스토리지 볼륨을 부여할 수 있어 이를 가능하게 합니다.
- 순서 보장: 스테이트풀 애플리케이션은 종종 순서가 중요한 작업을 처리해야 합니다. 스테이트풀셋은 파드를 순차적으로 생성하고 삭제할 수 있습니다.
- 고유 아이덴티티: 스테이트풀 애플리케이션은 각 인스턴스가 고유한 아이덴티티를 가지고 있어야 할 때가 있습니다. 예를 들어, 분산 데이터베이스에서는 각 노드가 고유한 역할을 가질 수 있습니다. 스테이트풀셋은 각 파드에 고유한 이름과 네트워크 아이덴티티를 부여합니다.
  - 가지고있어야 할 때 예시:
  - 분산 데이터베이스: 예를 들어, 분산 데이터베이스 시스템에서 각 노드가 특정한 역할을 하는 경우 (리더, 팔로워, 코디네이터 등) 각 노드에 고유한 아이덴티티가 필요합니다. 이를 통해 노드 간 데이터 동기화나 요청 라우팅을 올바르게 처리할 수 있습니다.
  - 스트리밍 애플리케이션: 카프카 같은 메시지 큐 시스템에서는 각 프로듀서와 컨슈머가 고유한 아이덴티티를 가지고 있어야 메시지를 올바르게 처리할 수 있습니다.
  - 클러스터 멤버십과 샤딩: 여러 서버 인스턴스가 데이터 샤드를 관리할 때, 각 샤드는 단 하나의 '오너' 노드에 의해 관리되어야 할 수 있습니다. 이때 오너 노드에게는 고유한 아이덴티티가 부여되어야 합니다.
  - 마스터-슬레이브 아키텍처: 마스터 노드가 다운되면 슬레이브 노드 중 하나가 마스터 노드로 승격되는 구조에서도 각 노드는 고유한 아이덴티티를 가져야 합니다.
  - 캐시 노드: 분산 캐시 시스템에서는 데이터 무결성을 유지하기 위해 각 캐시 노드가 고유한 아이덴티티를 가질 필요가 있을 수 있습니다.
  - 세션 저장: 로드 밸런서 뒤에 여러 개의 애플리케이션 서버가 있을 경우, 사용자의 세션 정보를 특정 서버에 저장하기 위해서는 서버에 고유한 아이덴티티가 필요할 수 있습니다.
- 재시작과 복구: 스테이트풀 애플리케이션의 경우, 노드가 실패한 후에도 같은 상태와 데이터로 재시작해야 할 필요가 있을 수 있습니다. 스테이트풀셋은 이러한 측면을 지원합니다.
- 업그레이드와 롤백: 스테이트풀 애플리케이션은 종종 복잡한 업그레이드와 롤백 절차를 가질 수 있습니다. 스테이트풀셋은 순차적 업데이트나 롤백을 지원하여 이 과정을 안전하게 관리할 수 있습니다.



## 10.1 스테이트풀 파드 복제하기
레플리카셋은 하나의 파드 템플릿에서 여러 개의 파드 레플리카를 생성한다. 레플리카는 이름과 IP 주소를 제외하면 모두 동일.  
파드 템플릿이 PVC를 참조하는 볼륨을 포함하면 레플리카셋의 모든 레플리카는 정확히 동일한 PVC를 사용, 클레임에 바인딩 된 동일한 PV를 사용하게 된다.  
<img width="684" alt="image" src="https://github.com/mason-ko/TIL/assets/30224146/c189758a-9a28-4848-882a-05465696a46d">

레플리카셋은 고유한 상태나 아이텐티티가 유지할 수 없기 때문에 분산 데이터베이스용으로는 실행이 불가능하다. (마스터,슬레이브, 설정 불가)

### 10.1.1 개별 스토리지를 갖는 레플리카 여러 개 실행하기
#### 파드 인스턴스별로 하나의 레플리카셋 사용하기 
<img width="414" alt="image" src="https://github.com/mason-ko/TIL/assets/30224146/7767c319-af8d-45cb-8994-14be72f0df46">




### 10.1.2 각 파드에 안정적인 아이덴티티 제공하기

## 10.2 스테이트풀셋 이해하기
### 10.2.1 스테이트풀셋과 레플리카셋 비교하기
### 10.2.2 안정적인 네트워크 아이덴티티 제공하기
### 10.2.3 각 스테이트풀 인스턴스에 안정적인 전용 스토리지 제공하기
### 10.2.4 스테이트풀셋 보장 이해하기

## 10.3 스테이트풀셋 사용하기
### 10.3.1 애플리케이션과 컨테이너 이미지 생성하기
### 10.3.2 스테이트풀셋을 통한 애플리케이션 배포하기
### 10.3.3 파드 가지고 놀기

## 10.4 스테이트풀셋의 피어 디스커버리
### 10.4.1 DNS를 통한 피어 디스커버리
### 10.4.2 스테이트풀셋 업데이트
### 10.4.3 클러스터된 데이터 저장소 사용하기

## 10.5 스테이트풀셋이 노드 실패를 처리하는 과정 이해하기
### 10.5.1 노드의 네트워크 연결 해제 시물레이션
### 10.5.2 수동으로 파드 삭제하기
